hey everyone welcome back to the channel uh I wanted to come on here and just take a quick moment to discuss cap theorem specifically in the context of system design interviews and so there's a lot of content on cap theum online I'm sure you've read some of it uh but most of which I find makes it way more daunting than it needs to be and none of which explains particularly well why it matters specifically in the context of a system design interview and so working with candidates every single day as I do as the co-founder of hello interview it's shown me just how much confusion there is around this maybe seemingly simple topic uh and so I want to hop on here and see if we could solve that confusion for you all uh kind of once and for all 

so if we turn our attention to the Whiteboard we can start with the very basic definition what is Cap theorem well cap theorem states that you can only have two out of three of the following consistency availability and partition tolerance so in a distributed system as is almost always the case in our system design interviews you'll have to choose two out of these three and so consistency we'll get into more details on each of these later on but consistency at a high level just means that all users see the same data at the same time availability means that every request gets a response whether it's successful or not and then partition tolerance is defined as the system works despite Network failures between nodes now why does this even matter in the first place why do we care about cap theorem and a system design interview that's because in a system design interview the first thing that you're going to do is you're going to align on the requir Ms with your interviewer and this is usually the functional requirements the features of the system and then the non-functional requirements which are the qualities of the system now when you're going over the non-functional requirements the first thing you should do is start with cap theorem you should ask yourself does this system need to prioritize consistency or availability and the reason that's the question is because if we come back up here to cap theorem partition tolerance in a distributed system is a must so we've chosen one out of our three and now the question that you in a system design interview need to wrestle with is simply do I prioritize consistency in my system or do PRI do I prioritize availability and this ends up being really important because it's going to have a significant influence on your design later on in the Deep Dives but why are these two things at odds with one another in the first place why do we have to choose between consistency and availability why not both well let's look at an example which will hopefully answer that question imagine that you host a website this website has two servers one located in the USA and one located in Europe now user a goes to write data to the server that they're connected to located in the United States let's say this data that they're writing is an update to their public profile maybe they're just updating their name once they do so that data is replicated to the server in Europe so that when user B goes to read the public profile of user a they see that latest data the updated name easy now what happens if this network connection between these two servers gets severed for some reason it goes down and more importantly what happens if it goes down uh before we had a chance to replicate that data that updated data from user uh from server a to the server in Europe well at this point we as a system have a decision to make when user B goes to read this data should we a give them an error because this data is now stale and so we don't want them to read stale data or B do we just let them view the stale data so writing that down in the case of a network failure should we a stop serving the data if we choose that option then our system has prioritized strong consistency if we chose that we can just risk giving them wrong data seeing the old name for a little bit until this is back online and figures itself out uh if that's okay then our system chose availability so what are some examples where we would choose option A we would stop serving data because we prioritized consistency in the context of cap theum well the first option would be if it was like a ticket booking platform either Airlines or events hotels and so imagine that what user a was doing when they wrote was that they were choosing seat 6A in an airplane and then our Network failure broke well user B is looking to book a seat on the same flight and if we showed them that seat 6A was still available when it's not this would be catastrophic it would mean that they could book seat 6A and both user a and user B would show up to the airport on the same day thinking that they're going to sit in the same seat obviously a problem so in that case we would choose consistency over availability what about like an inventory system like Amazon imagine that you're down to your last item user a is buying the last toothbrush on Amazon uh if we have our Network failure and user B goes and looks they would see that there was one AA ailable and they would buy it too now we only have one item but we have two users that think that they bought it that's catastrophic lastly another common example is financial systems imagine that user a goes to buy a stock and they hit the USA server user B goes to either buy or sell that same stock well the value of that stock particularly if it's a low float might have changed depending on the size of this sale in particular and so the order book needs to be kind of up to date and in this case it wouldn't be so we need to choose strong consistency we should show user be in error as opposed to showing them out ofate information now if you don't need strong consistency then you would choose availability and this would be everything else of course this list isn't exhaustive but in the case where you don't need strong consistency in the case where you can risk stale data this is the overwhelming majority of cases like our first example with profile data so what if user B reads the wrong name for a little period of time who cares so anything like in a social media app a user a posts some data user B doesn't see their post for a while or doesn't see an update to their post no big deal what about a service like Yelp where there's businesses that get reviewed and so maybe user a is a business and they're updating their business information and user B is a customer and they're going to see slightly out ofd business information for a couple seconds or maybe up to a minute or so it's totally fine we would rather show them the business because we want that business then uh you know care that one menu item is slightly out of date for a couple seconds same too with Netflix what if we change the description on a new movie or we update a new movie or we add a movie is it okay that the person in Europe doesn't see it for a couple seconds or they see something that's stale or out of date for a couple seconds of course it is and so what it comes down to in your interview is that when you're going over your non-functional requirements you are asking yourself a simple question does this system need strong consistency does it matter that every single user sees the same state of my system at any given time time and if they didn't would it be catastrophic if the answer to that question is yes you're going to prioritize consistency over availability if the answer to that question is no then you're going to prioritize availability over consistency great you made your decision in your non-functional requirements you decided either to prioritize consistency or availability but how does this influence Your Design now you have to go design the system well if you chose strong consistency you're going to keep a couple things in mind you might need to implement distributed transactions so if you had for example a cash in a database you need to ensure that those two things remain strongly consistent and so you'll have to guarantee that when a right happens to one the right happens to the other implementing a distributed transaction to ensure this you also might limit things to a single node like maybe your database is a single instance if it's a single instance then there can't be these propagation issues right and so you'll do the math and you might say for my airline ticket booking system I have a single database here and that single database is going to be something like a postgress database or a SQL database for which I can issue Atomic transactions and this way everybody views the same data because they're all reading from the same instance we also might need to just accept higher latency right so we're going to have to show users Spinners or something while we're waiting for propagation to happen um between instances and so some example tools or traditional relational database Management Systems your postgress is your sqls spanner offered by Google is a great option note that this doesn't mean if you have consistency you can't go with nosql many nosql databases offer strong consistency modes Dynamo DB offers one of them um it's controversial to some whether or not this would be the right choice in my opinion it's totally fine now what about if you ended up going with availability well if you go with availability then you can use multiple replicas you're going to scale out your system and can have different read replicas and it's okay if there's propagation between those read replicas eventual consist is okay things like CDC change data capture which is by definition eventually consistent is okay to use in your system uh you're going to use things like Dynam DB not with that strong consistency mode but with like multiple availability zones could be the configuration there Technologies like Cassandra uh which are well optimized for high availability these are all good decisions if you decided to prioritize availability in your system last thing before we wrap up here I have some Nuance to throw at you if you are a junior or mid-level candidate you might want to just stop the video now I don't want things to get confusing if you're senior or up then this is important to know and the important thing to understand here is that while we choose availability or consistency and those things are at odds we can have different parts of our system that prioritize different requirements so to make that clear imagine Ticket Master is a really good example in Ticket Master as we discussed we want to PRI prioritize consistency for booking tickets because we can't have double booking we can't have two users thinking they have the same seat but there are other parts of our system for which we should prioritize availability like for example the crud on events so creating updating deleting events if a user goes and updates the event description it's okay if that's eventually consistent uh it's better that people can always view the event and so in a system design interview you could be nuanced here with your interviewer and you could say as it pertains to cap theorem I'm going to prioritize availability for searching and viewing events but I'm going to prioritize consistency for booking tickets to events let's look at another example consider Tinder Tinder is a similar case where we need consistency for matching because if user a swiped on me in Europe and then I swipe on them in the United States I want to immediately show the user a match you matched right when you swipe if you're the second person swiping and so I need a consistent view of who swiped of me cool so consistency for matching but when it comes to viewing profile data again if a user went and updated their profile to a different picture or something like this it's okay if I see the old picture for a while couple seconds minutes so be it and so in Tinder I would say to my interviewer I'm going to prioritize availability for viewing profile data and updating profile data but I'm going to prioritize consistency for match data now there's one other thing in this so-called Advanced section that's relevant you'll hear consistency always used and people will just say consistency in the context of cap theorem what they really mean is strong consistency they mean all reads reflect that most recent write this is what we've been talking about so if you hear consistency in this context just think strong consistency but the reality is there's different levels to consistency and if you want to be fancy you can get into the Nuance of these different levels in your system and so there's also what's called causal consistency and this just ensures that related events appear in the same order and so for example you can't have a comment on a post uh maybe replying to a previous comment right that comes before that comment it's replying to that wouldn't make makes sense so it's okay if these things take a while to come in and not everyone sees all the same comments but nobody should see a comment replying to a previous comment in the inverted order hopefully that makes sense uh a third one here is read your own rights consistency and so this is that I as a user should have a consistent view of what I've just done but other users could see something different and so back to our USA Europe example user a who updated their profile should immediately see their own profile update or else they'll think the system was broken so they need read your rights consistency but the system doesn't need strong consistency because user B in Europe can still see the old thing that's fine and then of course as I've been alluding to throughout this this whole interview the lowest level of consistency is that eventual consistency so when we choose availability over consistency we're not saying our system's not going to be consistent we're just saying that we're okay with eventual consistency we're okay that it's going to take a while for the system to level outed into a consistent state so if you want to go into each of these in your interview it can show some Nuance it can show some senior some staff level thinking when you be specific here all right folks thanks for watching hopefully this was useful let me know in the comments what you think of this new format it ended up being longer than I thought it would be I thought this would be five minutes but uh you know let me know I want to hop in here and maybe make some of these periodically when I when I learn that something is a little bit more confusing to folks um as always we got a bunch of great breakdowns on the website hello interview.com a bunch more deep Dives on content just like this check it out and then actually at the end of this month November 2024 I don't know when you're watching this uh we're going to be launching a bunch more contents kind of in a premium offering so people are always asking for more content the free content will always continue the YouTube will continue um but we will have even more content for those who want to pay for premium so keep an eye on an eye out for that that'll be coming at the end of the month awesome all right folks good luck with your interviews